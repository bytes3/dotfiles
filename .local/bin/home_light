#!/usr/bin/env bash

. $HOME/.cache/wal/colors.sh

killall hass-cli

# TODO: Move this to KWallet
# Use this command to query the password: kwallet-query main -f env -r home_assistant_api
export HASS_TOKEN="$(cat $HOME/.config/api_keys/home_assistant)"
export HASS_SERVER="http://$PI_IP:8123"

ENTITY="light.yeelight_color4_0x15603376"
NOTIFICATION_ID="1101"
BRIGHTNESS_TMP="/tmp/brightness_level"

call_service() {
  timeout 2 ~/.local/bin/hass-cli -o json service call "$@"
}

notify() {
	notify-send -u low -r $NOTIFICATION_ID "$@"
}

turn_on() {
	call_service light.turn_on --arguments entity_id="$ENTITY"
}

turn_off() {
	call_service light.turn_off --arguments entity_id="$ENTITY"
}

toggle_light() {
	notify "Room Brightness" "Toggle"

	call_service light.toggle --arguments entity_id="$ENTITY"
}

## Refactor this mess ##
set_rgb_color() {
	VALUE_BRIGHTNESS=$1

	cat $BRIGHTNESS_TMP 2>/dev/null || echo 50 > $BRIGHTNESS_TMP

	CURRENT_BRIGHTNESS=$(cat $BRIGHTNESS_TMP 2>/dev/null)
	CURRENT_BRIGHTNESS=$((CURRENT_BRIGHTNESS+VALUE_BRIGHTNESS))

	[ "$CURRENT_BRIGHTNESS" -gt 100 ] && CURRENT_BRIGHTNESS=100
	[ "$CURRENT_BRIGHTNESS" -lt 1 ] && CURRENT_BRIGHTNESS=1

	echo $CURRENT_BRIGHTNESS > $BRIGHTNESS_TMP

  local rgb_color_value="$(hex_to_rgb_color $color2)"
  local color_result='{"entity_id": "'"$ENTITY"'", "brightness": "'$CURRENT_BRIGHTNESS'", "rgb_color": ['$rgb_color_value']}'

  ~/.local/bin/hass-cli --debug -o json raw post /api/services/yeelight/set_color_scene --json "$color_result"

	notify "Room Brightness" "Set to $CURRENT_BRIGHTNESS"
}

set_temp_brightness() {
	VALUE_BRIGHTNESS=$1

	cat $BRIGHTNESS_TMP 2>/dev/null || echo 50 > $BRIGHTNESS_TMP

	CURRENT_BRIGHTNESS=$(cat $BRIGHTNESS_TMP 2>/dev/null)
	CURRENT_BRIGHTNESS=$((CURRENT_BRIGHTNESS+VALUE_BRIGHTNESS))

	[ "$CURRENT_BRIGHTNESS" -gt 100 ] && CURRENT_BRIGHTNESS=100
	[ "$CURRENT_BRIGHTNESS" -lt 1 ] && CURRENT_BRIGHTNESS=1

	echo $CURRENT_BRIGHTNESS > $BRIGHTNESS_TMP

	call_service yeelight.set_color_temp_scene --arguments entity_id="$ENTITY",kelvin=4000,brightness="$CURRENT_BRIGHTNESS"

	notify "Room Brightness" "Set to $CURRENT_BRIGHTNESS"
}
## Refactor this mess ##

case $1 in
	toggle) toggle_light ;;
	turn_on) turn_on ;;
	turn_off) turn_off ;;
	bup) set_rgb_color 10 ;;
	bdown) set_rgb_color -10 ;;
esac

